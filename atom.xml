<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Xblog]]></title>
  <link href="http://passol.tk/atom.xml" rel="self"/>
  <link href="http://passol.tk/"/>
  <updated>2014-11-24T05:37:57+08:00</updated>
  <id>http://passol.tk/</id>
  <author>
    <name><![CDATA[passol]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[事件处理文档]]></title>
    <link href="http://passol.tk/blog/2014/11/24/shi-jian-chu-li-wen-dang/"/>
    <updated>2014-11-24T05:18:16+08:00</updated>
    <id>http://passol.tk/blog/2014/11/24/shi-jian-chu-li-wen-dang</id>
    <content type="html"><![CDATA[<h2>内置Gesture</h2>

<p><em>UITapGestureRecognizer</em>,<em>UIPinchGestureRecognizer</em>,
<em>UIPanGestureRecognizer</em>,
<em>UISwipeGestureRecognizer</em>,
<em>UIRotationGestureRecognizer</em>,<em>UILongPressGestureRecognizer</em>,</p>

<ol>
<li><p>指定顺序
swipe和pan手势</p></li>
<li><p>dd</p></li>
<li><p>dd</p></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[KVC程序设计(官方文档)]]></title>
    <link href="http://passol.tk/blog/2014/10/29/kvccheng-xu-she-ji-guan-fang-wen-dang/"/>
    <updated>2014-10-29T22:08:26+08:00</updated>
    <id>http://passol.tk/blog/2014/10/29/kvccheng-xu-she-ji-guan-fang-wen-dang</id>
    <content type="html"><![CDATA[<h1>KVC的定义</h1>

<p>该文档主要介绍<code>NSKeyValueCoding</code>协议,他实现了一种允许调用对象属性的名称(或键)的机制,而不是直接调用setter或者getter方法或者实例变量
实现KVC方法是重要的设计原则,有助于数据封装和配合kvo,CoreData,CocoaBinding等,甚至能简化代码</p>

<h2>KVC和脚本</h2>

<p>OSX主要依赖于KVC执行脚本命令,脚本内嵌的关键字也是KVC类型的API</p>

<h2>利用KVC简化代码</h2>

<figure class='code'><figcaption><span>未使用KVC</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>
</span><span class='line'>    <span class="o">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nl">tableView</span><span class="p">:(</span><span class="n">NSTableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableview</span> <span class="nl">objectValueForTableColumn</span><span class="p">:(</span><span class="kt">id</span><span class="p">)</span><span class="n">column</span>
</span><span class='line'>                                              <span class="nl">row</span><span class="p">:(</span><span class="bp">NSInteger</span><span class="p">)</span><span class="n">row</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">ChildObject</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="p">[</span><span class="n">childrenArray</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="n">row</span><span class="p">];</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">([[</span><span class="n">column</span> <span class="n">identifier</span><span class="p">]</span> <span class="nl">isEqualToString</span><span class="p">:</span><span class="s">@&quot;name&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">[</span><span class="n">child</span> <span class="n">name</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">([[</span><span class="n">column</span> <span class="n">identifier</span><span class="p">]</span> <span class="nl">isEqualToString</span><span class="p">:</span><span class="s">@&quot;age&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">[</span><span class="n">child</span> <span class="n">age</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">([[</span><span class="n">column</span> <span class="n">identifier</span><span class="p">]</span> <span class="nl">isEqualToString</span><span class="p">:</span><span class="s">@&quot;favoriteColor&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">[</span><span class="n">child</span> <span class="n">favoriteColor</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>使用KVC</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>
</span><span class='line'>    <span class="o">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nl">tableView</span><span class="p">:(</span><span class="n">NSTableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableview</span> <span class="nl">objectValueForTableColumn</span><span class="p">:(</span><span class="kt">id</span><span class="p">)</span><span class="n">column</span>
</span><span class='line'>                                           <span class="nl">row</span><span class="p">:(</span><span class="bp">NSInteger</span><span class="p">)</span><span class="n">row</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">ChildObject</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="p">[</span><span class="n">childrenArray</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="n">row</span><span class="p">];</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">[</span><span class="n">child</span> <span class="nl">valueForKey</span><span class="p">:[</span><span class="n">column</span> <span class="n">identifier</span><span class="p">]];</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>基本术语</h1>

<p>kvc主要用做取得三种类型的对象值(<em>property</em>):</p>

<ol>
<li><strong>attribute</strong>属性关系,比如NSNumber,NSColor</li>
<li><strong>to-one relationship</strong>对一关系,通常是被所属关系,UIView的superView</li>
<li><strong>to-many relationship</strong>对多关系,通常是所属的集合类属性,如NSArray或NSSet</li>
</ol>


<h1>KVC基础</h1>

<h2>键和keyPaths</h2>

<ol>
<li>key必须是ASCII编码,小写字母开头,不能包含空格,如<em>payee</em></li>
<li>key paths是用.隔开,遍历对象对最终的值,如 <em>address.street</em></li>
</ol>


<h2>KVC取值</h2>

<ul>
<li><code>valueForKey:</code>返回对象的对应的键值,如果没有方法或实例变量,receiver会发出<code>valueForUndefinedKey:</code>消息.而默认的<code>valueForUndefinedKey:</code>会抛出<code>NSUndefinedKeyException</code>异常</li>
<li><code>valueForKeyPath:</code>也会抛出一样的异常</li>
<li><code>dictionaryWithValuesForKeys:</code>返回对象所有的键关联的数组.返回的字典包含数组所有的键值</li>
</ul>


<h2>KVC赋值</h2>

<ul>
<li><code>setValue:forKey:</code>赋对象键值.默认的方法自动解封装<code>NSValue</code>对象.如果key不存在,对象默认发送<code>setValue:forUndefinedKey:</code>方法,抛出<code>NSUndefinedKeyException</code>异常</li>
<li><code>setValue:forKeyPath:</code>也有类似的处理方式</li>
<li><code>setValuesForKeysWithDictionary:</code>就是N个<code>setValue:forKey:</code>(必要是要用nil或者NSNull)</li>
<li>还有种情况需要考虑,对象给不是对象的属性赋nil值,就会发出<code>setNilValueForKey:</code>消息,抛出<code>NSInvalidArgumentException</code>异常</li>
</ul>


<h2>.语法和KVC</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">MyClass</span>
</span><span class='line'><span class="k">@property</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">stringProperty</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="bp">NSInteger</span> <span class="n">integerProperty</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="n">MyClass</span> <span class="o">*</span><span class="n">linkedInstance</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>直接用KVC修改</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="n">MyClass</span> <span class="o">*</span><span class="n">myInstance</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MyClass</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>  <span class="bp">NSString</span> <span class="o">*</span><span class="n">string</span> <span class="o">=</span> <span class="p">[</span><span class="n">myInstance</span> <span class="nl">valueForKey</span><span class="p">:</span><span class="s">@&quot;stringProperty&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">myInstance</span> <span class="nl">setValue</span><span class="p">:</span><span class="mi">@2</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&quot;integerProperty&quot;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>.语法修改</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="n">MyClass</span> <span class="o">*</span><span class="n">anotherInstance</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MyClass</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>  <span class="n">myInstance</span><span class="p">.</span><span class="n">linkedInstance</span> <span class="o">=</span> <span class="n">anotherInstance</span><span class="p">;</span>
</span><span class='line'>  <span class="n">myInstance</span><span class="p">.</span><span class="n">linkedInstance</span><span class="p">.</span><span class="n">integerProperty</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>结合起来修改</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="n">MyClass</span> <span class="o">*</span><span class="n">anotherInstance</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MyClass</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>  <span class="n">myInstance</span><span class="p">.</span><span class="n">linkedInstance</span> <span class="o">=</span> <span class="n">anotherInstance</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[</span><span class="n">myInstance</span> <span class="nl">setValue</span><span class="p">:</span><span class="mi">@2</span> <span class="nl">forKeyPath</span><span class="p">:</span><span class="s">@&quot;linkedInstance.integerProperty&quot;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h1>KVC赋/取方法常用方法:</h1>

<ul>
<li><code>valueForKey:</code>,</li>
<li><code>setValue:forKey:</code>,</li>
<li><code>mutableArrayValueForKey:</code>,</li>
<li><code>mutableSetValueForKey:</code></li>
</ul>


<p>通用accessor方法
- getter. -<key>
- 第二种   -is<key>
- setter, -set<key>:
- 如果属性不是对象,你就必须在适当的时候手动赋给nil值</p>

<p>针对<strong>to-many</strong>属性集合类型
- 有序的accessor类型</p>

<p>不可变</p>

<ol>
<li>countOf<key> 必须</li>
<li><em>-objectIn<Key>AtIndex:</em> or <em>-<key>AtIndexes:</em> 必须实现一个.他对应<em>objectAtIndex:</em>和 <em>objectsAtIndexes:</em></li>
<li>-get<Key>:range: 可选实现,返回NSArray.对应NSArray的<em>getObjects:range:</em></li>
</ol>


<p>可变</p>

<ol>
<li>-insertObject:in<Key>AtIndex: or -insert<Key>:atIndexes: 至少实现一个</li>
<li>-removeObjectFrom<Key>AtIndex: or -remove<Key>AtIndexes: 至少实现一个</li>
<li>-replaceObjectIn<Key>AtIndex:withObject: or -replace<Key>AtIndexes:with<Key>:可选</li>
</ol>


<hr />

<ul>
<li>无序的accessor类型</li>
</ul>


<p>不可变</p>

<ol>
<li>-countOf<key> 必须 count</li>
<li>-enumeratorOf<key> 必须objectEnumerator</li>
<li>-memberOf<key> 必须</li>
</ol>


<p>可变</p>

<ol>
<li>-add<Key>Object: or -add<Key>: 必须实现一个</li>
<li>-remove<Key>Object: or -remove<Key>: 必须实现一个</li>
<li>-intersect<Key> 可选</li>
</ol>


<h1>KVC验证</h1>

<h2>调用验证方法</h2>

<ul>
<li><code>validateValue:forKey:error:</code>默认实现是匹配模式<em>validate<Key>:error:</em></li>
<li>自动验证,一般CoreData会自动验证</li>
<li>验证scalar values</li>
</ul>


<h1>确保兼容KVC</h1>

<h2>属性和对一关系</h2>

<ul>
<li><code>-&lt;key&gt;</code>,<code>-is&lt;key&gt;</code>或者实例变量<code>&lt;key&gt;</code>或者<code>_&lt;key&gt;</code>,也可以用大写</li>
<li>可变属性也有<code>set&lt;key&gt;</code></li>
<li><code>set&lt;key&gt;</code>不会执行验证</li>
<li>如果验证对key合适,实现<code>-validate&lt;key&gt;:error:</code></li>
</ul>


<h2>有序对多关系</h2>

<ul>
<li><code>-&lt;key&gt;</code></li>
<li>实例变量<code>&lt;key&gt;</code>,或者<code>_&lt;key&gt;</code></li>
<li><code>-countOf&lt;key&gt;</code>和 <code>-objectIn&lt;Key&gt;AtIndex:</code>或<code>-&lt;key&gt;AtIndexes:</code></li>
<li><code>-get&lt;key&gt;:range:</code>
对可变有序对多关系来说,还要</li>
<li><code>insertObject:in&lt;Key&gt;AtIndex:</code>或<code>-insert&lt;Key&gt;:atIndexes:</code></li>
<li><code>removeObjectFrom&lt;Key&gt;AtIndex:</code>或<code>remove&lt;Key&gt;AtIndexes:</code></li>
<li>可选,<code>-replaceObjectIn&lt;Key&gt;AtIndex:withObject:</code>或<code>replace&lt;Key&gt;AtIndexes:with&lt;ley&gt;:</code></li>
</ul>


<h2>无序序对多关系</h2>

<ul>
<li><code>-&lt;key&gt;</code></li>
<li>实例变量<code>&lt;key&gt;</code>或<code>_&lt;key&gt;</code></li>
<li><code>-countOf&lt;key&gt;</code>,<code>-enumerateOf&lt;key&gt;</code>和<code>-memberOf&lt;key&gt;</code>
对可变的无序关系来说,还要</li>
<li><code>-add&lt;key&gt;Object:</code>或<code>-add&lt;Key&gt;</code></li>
<li><code>-remove&lt;key&gt;Object:</code>或<code>-remove&lt;key&gt;</code></li>
<li>可选,<code>-intersect&lt;key&gt;:</code>和<code>-set&lt;Key&gt;:</code></li>
</ul>


<h1>扩展数据类型</h1>

<h2>表示非对象类型的值</h2>

<p><code>valueForKey:</code>和<code>setValue:forKey:</code>提供自动封装非对象类型的值</p>

<h2>处理空值</h2>

<p>默认的<code>setNilValueForKey:</code>会抛出<code>NSInvalidArgumentException</code>异常,子类可以重写该方法</p>

<h1>对集合的操作</h1>

<p><strong>keypathToCollection.@collectionOperator.keypathToProperty</strong></p>

<p>@avg</p>

<ul>
<li><code>NSNumber *transactionAverage = [transactions valueForKeyPath:@"@avg.amount"];</code>@count</li>
<li><p><code>NSNumber *numberOfTransactions = [transactions valueForKeyPath:@"@count"];</code>
@max- <code>NSDate *latestDate = [transactions valueForKeyPath:@"@max.date"];</code>@min</p></li>
<li><p><code>NSDate *earliestDate = [transactions valueForKeyPath:@"@min.date"];</code>@sum</p></li>
<li><p><code>NSNumber *amountSum = [transactions valueForKeyPath:@"@sum.amount"];</code>@distinctUnionOfObjects</p></li>
<li><code>NSArray *payees = [transactions valueForKeyPath:@"@distinctUnionOfObjects.payee"];</code>@unionOfObjects</li>
<li><code>NSArray *payees = [transactions valueForKeyPath:@"@unionOfObjects.payee"];</code>数组和set操作
@distinctUnionOfArrays</li>
<li><code>NSArray *payees = [arrayOfTransactionsArrays valueForKeyPath:@"@distinctUnionOfArrays.payee"]</code>@unionOfArrays</li>
<li><code>NSArray *payees = [arrayOfTransactionsArraysvalueForKeyPath:@"@unionOfArrays.payee"];</code>
@distinctUnionOfSets</li>
</ul>


<h1>KVC方法搜索实现细节</h1>

<h2>简单属性</h2>

<p><code>setValue:forKey:</code>调用成员是按照以下模式:
1. 对象类搜索是否存在存取方法<code>set&lt;Key&gt;:</code>
2. 如果没有,对象类方法<code>accessInstanceVariablesDirectly</code>返回YES.对象一词按顺序搜索<code>_&lt;key&gt;</code>,<code>_is&lt;Key&gt;</code>,<code>&lt;key&gt;</code>,<code>is&lt;Key&gt;</code>
3. 如果定位到函数或实例变量,进行设置值.如有必要,可以拆开对象(NSNumber,NSValue)
4. 如果仍然没有,调用<code>setValue:forUndefinedKey:</code></p>

<p><code>valueForKey:</code>调用成员是按照以下模式:
1. 按顺序搜索<code>get&lt;Key&gt;</code>,<code>&lt;key&gt;</code>,<code>is&lt;Key&gt;</code>.如果结果是扩展类型,也可以返回NSNumber或NSValue类型
2. <code>countOf&lt;Key&gt;</code>和<code>objectIn&lt;Key&gt;AtIndex:</code>(NSArray)或<code>&lt;key&gt;AtIndexes:</code>，备选<code>get&lt;Key&gt;:range:</code>
3. <code>countOf&lt;Key&gt;</code>,<code>enumeratorOf&lt;Key&gt;</code>和<code>memberOf&lt;Key&gt;</code>
4. 如果<code>accessInstanceVariablesDirectly</code>返回YES.类会寻找实例变量<code>_&lt;key&gt;</code>,<code>_is&lt;key&gt;</code>,<code>&lt;key&gt;</code>和<code>is&lt;key&gt;</code>.必要时做转化
5. <code>valueForUndefinedKey:</code></p>

<h2>读有序集合</h2>

<ol>
<li><code>insertObject:in&lt;Key&gt;AtIndex:</code>和<code>removeObjectFrom&lt;Key&gt;AtIndex:</code>(对应NSMutableArray的 <code>insertObject:atIndex:</code> and <code>removeObjectAtIndex:</code>).或者<code>insert&lt;Key&gt;:atIndexes:</code>和<code>remove&lt;Key&gt;AtIndexes:</code>.或者提高性能使用<code>replaceObjectIn&lt;Key&gt;AtIndex:withObject:</code>或<code>replace&lt;Key&gt;AtIndexes:with&lt;Key&gt;:</code></li>
<li>搜索<code>set&lt;Key&gt;:</code></li>
<li>如果类方法<code>accessInstanceVariablesDirectly</code>返回YES.搜索实例变量<code>_&lt;key&gt;</code>或<code>&lt;key&gt;</code></li>
<li><code>setValue:forUndefinedKey:</code>(报错)</li>
</ol>


<h2>写有序集合</h2>

<ol>
<li><code>insertObject:in&lt;key&gt;AtIndex:</code>和<code>removeObjectFrom&lt;Key&gt;AtIndex:</code></li>
<li><code>set&lt;Key&gt;:</code></li>
<li>如果类方法<code>accessInstanceVariablesDirectly</code>返回YES.搜索<code>_&lt;key&gt;</code>或<code>&lt;key&gt;</code></li>
<li><code>setValue:forUndefinedKey:</code>(报错)</li>
</ol>


<h2>读无序集合</h2>

<ol>
<li><code>add&lt;Key&gt;Object:</code>和<code>remove&lt;Key&gt;Object:</code></li>
<li>CoreData似管理</li>
<li><code>set&lt;Key&gt;:</code></li>
<li>如果类方法<code>accessInstanceVariablesDirectly</code>返回YES,搜索实例变量<code>_&lt;key&gt;</code>和<code>&lt;key&gt;</code></li>
<li><code>setValue:forUndefinedKey:</code></li>
</ol>


<h1>更多资料</h1>

<ol>
<li><a href="http://stackoverflow.com/questions/15968741/ios-kvc-why-doesnt-it-invoke-countofkey-when-i-invoke-myobject-valueforke/">http://stackoverflow.com/questions/15968741/ios-kvc-why-doesnt-it-invoke-countofkey-when-i-invoke-myobject-valueforke/</a></li>
<li><a href="http://iloss.me/post/kai-fa/2014-01-18-ios-kvc">http://iloss.me/post/kai-fa/2014-01-18-ios-kvc</a></li>
<li><a href="http://nijino.qiniudn.com/blog/2013/07/02/using-kvc/">http://nijino.qiniudn.com/blog/2013/07/02/using-kvc/</a></li>
<li><a href="http://zhangbin.cc/2012/08/16/kvc-kvo/">http://zhangbin.cc/2012/08/16/kvc-kvo/</a></li>
<li><a href="http://nshipster.com/kvc-collection-operators/">http://nshipster.com/kvc-collection-operators/</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[KVO程序设计(官方文档)]]></title>
    <link href="http://passol.tk/blog/2014/10/28/kvocheng-xu-she-ji-guan-fang-wen-dang/"/>
    <updated>2014-10-28T00:04:03+08:00</updated>
    <id>http://passol.tk/blog/2014/10/28/kvocheng-xu-she-ji-guan-fang-wen-dang</id>
    <content type="html"><![CDATA[<h1>简要介绍</h1>

<p><a href="" title="key-value observing">kvo</a>是允许对象监视另一对象属性变化的一种机制.</p>

<h2>初步认识</h2>

<p>kvo常用作model和controller相互通信(在osx中, controller通常用绑定实现kvo机制).controller经常监视model属性变化,然后刷新UI.model对象也可以观察另外的model属性变化.</p>

<p>kvo可以观察哪些属性呢?基本属性,对单关系,对多关系等.</p>

<p>下面通过一个例子说明kvo怎么运作
1. 场景:当一个对象的某个对象发生变化,总希望通知另一对象.如银行的存款发生变化总会通知用户
2. 户主就必须注册为观察者,发送<code>addObserver:forKeyPath:options:context:</code>的消息
3. 为了能应对收到通知,观察者还必须实现<code>observeValueForKeyPath:ofObject:change:context:</code>.
4. 当对象属性发生变化时,<code>observeValueForKeyPath:ofObject:change:context:</code>立即调用</p>

<p>kvo的好处在于你不必写很多基础代码,由于已经集成在框架里,甚至可以轻松设置多个观察者.通知不是使用<code>NSNotificationCenter</code>,没有中枢管理所有观察者的通知.<code>NSObject</code>已经提供了KVO的实现,所以你可以完全使用.</p>

<h1>注册kvo</h1>

<p>观察者需要满足三个条件:
1. 被观察的类属性必须兼容kvo(&ldquo;KVO Compliance&rdquo;)
2. <code>addObserver:forKeyPath:options:context:.</code>
3. <code>observeValueForKeyPath:ofObject:change:context:.</code></p>

<h2>注册</h2>

<p>使用<code>NSKeyValueObservingOptionOld</code>或者<code>NSKeyValueObservingOptionNew</code>标记改变前后的值</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="p">[</span><span class="n">account</span> <span class="nl">addObserver</span><span class="p">:</span><span class="n">inspector</span>
</span><span class='line'>              <span class="nl">forKeyPath</span><span class="p">:</span><span class="s">@&quot;openingBalance&quot;</span>
</span><span class='line'>                  <span class="nl">options</span><span class="p">:(</span><span class="n">NSKeyValueObservingOptionNew</span> <span class="o">|</span>                            <span class="n">NSKeyValueObservingOptionOld</span><span class="p">)</span>
</span><span class='line'>                  <span class="nl">context</span><span class="p">:</span><span class="nb">NULL</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>context是独特的标示符,或者引用指针.</p>

<h2>收到通知</h2>

<p><code>NSKeyValueChangeNewKey</code>
<code>NSKeyValueChangeInsertion</code>
<code>NSKeyValueChangeRemoval</code>
<code>NSKeyValueChangeReplacement</code></p>

<h2>取消观察</h2>

<p>如果context指向的对象,你必须保持强引用防止被删除</p>

<h1>KVO Compliance</h1>

<p>特定值适合kvo comliance:
1. 特定的属性满足kvo
2. 发出通知
3. 关联值注册</p>

<h2>自动改变通知</h2>

<p>使用<code>mutableArrayValueForKey</code></p>

<h2>手动改变通知</h2>

<ul>
<li><code>automaticallyNotifiesObserversForKey</code>返回NO关闭自动通知</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="nb">self</span> <span class="nl">willChangeValueForKey</span><span class="p">:</span><span class="s">@&quot;openingBalance&quot;</span><span class="p">];</span>
</span><span class='line'><span class="n">_openingBalance</span> <span class="o">=</span> <span class="n">theBalance</span><span class="p">;</span>
</span><span class='line'><span class="p">[</span><span class="nb">self</span> <span class="nl">didChangeValueForKey</span><span class="p">:</span><span class="s">@&quot;openingBalance&quot;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h1>注册依赖键</h1>

<h2>单一关系</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">fullName</span><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;%@ %@&quot;</span><span class="p">,</span><span class="n">firstName</span><span class="p">,</span> <span class="n">lastName</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用<code>keyPathsForValuesAffectingValueForKey</code>增加对<em>firstName</em>和<em>lastName</em>的观察
也可以直接使用<code>keyPathsForValuesAffectingFullName</code></p>

<h2>对多关系</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">observeValueForKeyPath:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span> <span class="nf">ofObject:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">object</span>
</span><span class='line'>     <span class="nf">change:</span><span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">change</span> <span class="nf">context:</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="nv">context</span> <span class="p">{</span>
</span><span class='line'>         <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">==</span> <span class="n">totalSalaryContext</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>             <span class="p">[</span><span class="nb">self</span> <span class="n">updateTotalSalary</span><span class="p">];</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>         <span class="k">else</span>
</span><span class='line'>         <span class="c1">// deal with other observations and/or invoke super...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">updateTotalSalary</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="nb">self</span> <span class="nl">setTotalSalary</span><span class="p">:[</span><span class="nb">self</span> <span class="nl">valueForKeyPath</span><span class="p">:</span><span class="s">@&quot;employees.@sum.salary&quot;</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setTotalSalary:</span><span class="p">(</span><span class="bp">NSNumber</span> <span class="o">*</span><span class="p">)</span><span class="nv">newTotalSalary</span> <span class="p">{</span>
</span><span class='line'>         <span class="k">if</span> <span class="p">(</span><span class="n">totalSalary</span> <span class="o">!=</span> <span class="n">newTotalSalary</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>             <span class="p">[</span><span class="nb">self</span> <span class="nl">willChangeValueForKey</span><span class="p">:</span><span class="s">@&quot;totalSalary&quot;</span><span class="p">];</span>
</span><span class='line'>             <span class="n">_totalSalary</span> <span class="o">=</span> <span class="n">newTotalSalary</span><span class="p">;</span>
</span><span class='line'>             <span class="p">[</span><span class="nb">self</span> <span class="nl">didChangeValueForKey</span><span class="p">:</span><span class="s">@&quot;totalSalary&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSNumber</span> <span class="o">*</span><span class="p">)</span><span class="nf">totalSalary</span> <span class="p">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">_totalSalary</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>也可以使用CoreData</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[并发编程指南(官方文档)]]></title>
    <link href="http://passol.tk/blog/2014/10/25/bing-fa-bian-cheng-zhi-nan-guan-fang-wen-dang/"/>
    <updated>2014-10-25T05:26:11+08:00</updated>
    <id>http://passol.tk/blog/2014/10/25/bing-fa-bian-cheng-zhi-nan-guan-fang-wen-dang</id>
    <content type="html"><![CDATA[<h1>并发与程序设计</h1>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用RAC使用MVVM教程(1)]]></title>
    <link href="http://passol.tk/blog/2014/10/25/yong-racshi-yong-mvvmjiao-cheng-1/"/>
    <updated>2014-10-25T02:38:33+08:00</updated>
    <id>http://passol.tk/blog/2014/10/25/yong-racshi-yong-mvvmjiao-cheng-1</id>
    <content type="html"><![CDATA[<blockquote><p>所谓的IOS架构,MVC就代表重量级的VC  &ndash; <a href="https://twitter.com/Colin_Campbell/status/293167951132098560">Colin Campbell</a></p></blockquote>

<p>本教程将讲述另一种架构APP的方式:MVVM.它搭配MVVM方式，提供了可替代MVC方式的完美方案</p>

<h1>RAC简要介绍</h1>

<ul>
<li>RAC的核心就是信号,就是<code>RACSignal</code>类.信号可以发出事件流:<em>next</em>,<em>completed</em>和<em>error</em>
在简单的场景中,rac可以取代代理模式.TA模式,和观察者模式等</li>
<li>信号提供的API更容易使用和阅读,但是RAC更大的作用是能对信号做复杂的处理,满足实现要求.</li>
<li>详情可以阅读<a href="http://www.raywenderlich.com/?p=62699">earlier tutorial series</a></li>
</ul>


<h1>MVVM简要介绍</h1>

<p>MV*系列的模式(MVC或MVP等)核心在于分割UI逻辑和业务逻辑,让发开更方便.</p>

<p>更多资料可以阅读<a href="http://www.raywenderlich.com/?p=46988">Eli</a>或<a href="http://www.objc.io/issue-13/mvvm.html">Ash Furrow</a>的文章</p>

<p>MVC模型图大致如下:
<img src="http://cdn4.raywenderlich.com/wp-content/uploads/2014/06/MVCPattern-2.png" title="MVC模式" alt="Smaller icon" />
在MVC模式中,Model代表APP数据,View代表控件集合,而C则负责中间协调调度
设计的初衷是好的,但是Controler往往变得逻辑复杂,代码多</p>

<p>最近Martin Fowler提出了MVC的变种,也被微软采用了MVVM模式
<img src="http://cdn5.raywenderlich.com/wp-content/uploads/2014/06/MVVMPattern.png" title="MVC模式" alt="Smaller icon" /></p>

<p>这种模式的核心是ViewModel,特殊的Model专门表示UI状态,我们可以称之为View的model.基本规则是:
1. View有一个引用到ViewModel,反之不一定.(简单来说,View总有一个VM可以管理他)
2. ViewModel有一个引用指向Model,反之不一定
这样的规定带来的好处有:
1. 轻量级的Views,所有的UI逻辑都在ViewModel里面,View显得更轻量级
2. 方便测试</p>

<h1>MVVM和数据绑定</h1>

<p>MVVM依赖于数据绑定,能自动关联对象属性到UI控件
- 微软的<a href="">WPF</a>框架就提供了这种双向绑定</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;TextField Text=”{DataBinding Path=Username, Mode=TwoWay}”/&gt;</span></code></pre></td></tr></table></div></figure>


<p>VM的<em>username</em>属性和<em>textField</em>的内容就绑定到一起</p>

<ul>
<li>Web端也提供了类似的框架<a href="http://knockoutjs.com/">Knockout</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;input data-bind=”value: username”/&gt;</span></code></pre></td></tr></table></div></figure>


<p>实现HTML元素和JS Model的关联</p>

<ul>
<li>原生的IOS没有提供数据绑定的框架,而第三方库RAC就提供了这种功能
<img src="http://cdn5.raywenderlich.com/wp-content/uploads/2014/06/MVVMReactiveCocoa.png" title="IOS 的MVVM类图" alt="" /></li>
</ul>


<p>这有篇文章专门介绍GUI架构,来自<a href="http://martinfowler.com/eaaDev/uiArchs.html">Martin Fowler</a></p>

<h1>动手编程</h1>

<p>下载启动文件<a href="http://cdn5.raywenderlich.com/wp-content/uploads/2014/06/FlickrSearchStarterProject1.zip">FlickrSearchStarterProject.zip</a></p>

<p>我们使用<a href="http://www.raywenderlich.com/?p=64546">CocoaPods</a>管理库文件,只需要运行<code>pod install</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[FRP in IOS翻译(5)]]></title>
    <link href="http://passol.tk/blog/2014/10/24/frp-in-iosfan-yi-5/"/>
    <updated>2014-10-24T03:04:09+08:00</updated>
    <id>http://passol.tk/blog/2014/10/24/frp-in-iosfan-yi-5</id>
    <content type="html"><![CDATA[<h1>MVVM</h1>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[理解block]]></title>
    <link href="http://passol.tk/blog/2014/10/24/li-jie-block/"/>
    <updated>2014-10-24T00:00:35+08:00</updated>
    <id>http://passol.tk/blog/2014/10/24/li-jie-block</id>
    <content type="html"><![CDATA[<h2>引言</h2>

<p>Blocks非常方便使用,在使用中通常使用以下方式:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="k">__weak</span> <span class="n">__typeof__</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="n">weakSelf</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'>  <span class="nb">self</span><span class="p">.</span><span class="n">block</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>      <span class="n">__typeof__</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="n">strongSelf</span> <span class="o">=</span> <span class="n">weakSelf</span><span class="p">;</span>
</span><span class='line'>      <span class="p">[</span><span class="n">strongSelf</span> <span class="n">doSomething</span><span class="p">];</span><span class="c1">//片段1</span>
</span><span class='line'>      <span class="p">[</span><span class="n">strongSelf</span> <span class="n">doSomethingElse</span><span class="p">];</span><span class="c1">//片段2</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<h2>block运行机制</h2>

<ul>
<li>block创建在栈上,当栈帧返回的时候释放.在栈中的时候,block不会对使用的任何对象保留或者释放.</li>
<li>但当栈帧返回时候热然需要使用block的时候,我们会复制block到堆里(这是显式行为).Block会在整个作用域保留所有的使用对象.</li>
<li><p>block可以包含代码段,同时也要在生命周期保存状态.具体来讲,Block保留括号内所有变量.所以使用<code>__weak</code>避免重复包含.</p></li>
<li><p>当代码执行时,有可能出现片段1成功执行,片段2不执行(因为self可能为<em>nil</em>)</p></li>
<li>在block执行时创建指向self的强引用,然后保留对象</li>
<li>实践来讲,最好创建指向weakSelf的强引用.他不会引起<strong>retain cycle</strong>因为强引用只存在于block执行期间,所以使用<code>__strong</code></li>
</ul>


<h2>block一定不能retain self么</h2>

<p>也不一定,当其他对象的block引用self,虽然也会保存状态,但是不会引起<strong>retain cycle</strong></p>

<h2>拓展</h2>

<p>上述方式虽然好,不过不够简洁.幸好有<a href="https://github.com/jspahrsummers/libextobjc">libextobjc</a>提供了<strong>@weakify()</strong>和<strong>@strongify()</strong>.上述代码可以精简成:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="p">@</span><span class="n">weakify</span><span class="p">(</span><span class="nb">self</span><span class="p">);</span>
</span><span class='line'>  <span class="nb">self</span><span class="p">.</span><span class="n">block</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>      <span class="p">@</span><span class="n">strongify</span><span class="p">(</span><span class="nb">self</span><span class="p">);</span>
</span><span class='line'>      <span class="p">[</span><span class="nb">self</span> <span class="n">doSomething</span><span class="p">];</span><span class="c1">//片段1</span>
</span><span class='line'>      <span class="p">[</span><span class="nb">self</span> <span class="n">doSomethingElse</span><span class="p">];</span><span class="c1">//片段2</span>
</span><span class='line'>  <span class="p">};</span>   
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<h2>更多资料</h2>

<ol>
<li><a href="http://www.fantageek.com/1090/understanding-weak-self-and-strong-self/">http://www.fantageek.com/1090/understanding-weak-self-and-strong-self/</a></li>
<li><a href="http://aceontech.com/objc/ios/2014/01/10/weakify-a-more-elegant-solution-to-weakself.html">http://aceontech.com/objc/ios/2014/01/10/weakify-a-more-elegant-solution-to-weakself.html</a></li>
<li><a href="http://www.idryman.org/blog/2012/11/22/arc-best-practices-and-pitfalls/">http://www.idryman.org/blog/2012/11/22/arc-best-practices-and-pitfalls/</a>(内容详实)</li>
<li><a href="http://dhoerl.wordpress.com/2013/04/23/i-finally-figured-out-weakself-and-strongself/">http://dhoerl.wordpress.com/2013/04/23/i-finally-figured-out-weakself-and-strongself/</a></li>
<li><a href="http://stackoverflow.com/questions/19018456/ios-blocks-and-strong-weak-references-to-self">http://stackoverflow.com/questions/19018456/ios-blocks-and-strong-weak-references-to-self</a></li>
<li><a href="http://blackpixel.com/blog/2014/03/capturing-myself.html">http://blackpixel.com/blog/2014/03/capturing-myself.html</a>(我尚未看)</li>
<li><a href="http://albertodebortoli.github.io/blog/2013/08/03/objective-c-blocks-caveat/">http://albertodebortoli.github.io/blog/2013/08/03/objective-c-blocks-caveat/</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[FRP in IOS翻译(4)]]></title>
    <link href="http://passol.tk/blog/2014/10/23/frp-in-iosfan-yi-4/"/>
    <updated>2014-10-23T01:23:06+08:00</updated>
    <id>http://passol.tk/blog/2014/10/23/frp-in-iosfan-yi-4</id>
    <content type="html"><![CDATA[<h1>RAC实践</h1>

<p>作者举例<a href="https://github.com/AshFurrow/FunctionalReactivePixels">FunctionalReactivePixels</a></p>

<h2>基本信息</h2>

<ul>
<li>分别创建<code>UICollectionViewController</code>的子类<code>FRPGalleryViewController</code>和<code>UICollectionViewFlowLayout</code>的子类<code>FRPGalleryFlowLayout</code></li>
</ul>


<figure class='code'><figcaption><span>init初始化</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="o">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">init</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">FRPGalleryFlowLayout</span> <span class="o">*</span><span class="n">flowLayout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">FRPGalleryFlowLayout</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>      <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">initWithCollectionViewLayout</span><span class="p">:</span><span class="n">flowLayout</span><span class="p">];</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">self</span><span class="p">)</span> <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>初始化*layout*</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="o">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="n">init</span> <span class="p">{</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">]))</span> <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">itemSize</span> <span class="o">=</span> <span class="n">CGSizeMake</span><span class="p">(</span><span class="mi">145</span><span class="p">,</span> <span class="mi">145</span><span class="p">);</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">minimumInteritemSpacing</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">minimumLineSpacing</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">sectionInset</span> <span class="o">=</span> <span class="n">UIEdgeInsetsMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>初始化<code>application: didFinishLaunchingWithOptions:</code>函数</li>
</ul>


<figure class='code'><figcaption><span>系统委托函数</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="bp">UIApplication</span><span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nb">self</span><span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">UIWindow</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame</span><span class="p">:[[</span><span class="bp">UIScreen</span> <span class="n">mainScreen</span><span class="p">]</span> <span class="n">bounds</span><span class="p">]];</span>
</span><span class='line'>  <span class="nb">self</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">UINavigationController</span> <span class="n">alloc</span><span class="p">]</span>            <span class="nl">initWithRootViewController</span><span class="p">:[[</span><span class="n">FRPGalleryViewController</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">]];</span>
</span><span class='line'>  <span class="nb">self</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="bp">UIColor</span> <span class="n">whiteColor</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">window</span> <span class="n">makeKeyAndVisible</span><span class="p">];</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>搭建model类<code>FRPPhotoModel</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="p">@</span><span class="nl">interfaceFRPPhotoModel</span><span class="p">:</span><span class="bp">NSObject</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">@property</span><span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">strong</span><span class="p">)</span><span class="bp">NSString</span><span class="o">*</span><span class="n">photoName</span><span class="p">;</span>
</span><span class='line'>  <span class="k">@property</span><span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">strong</span><span class="p">)</span><span class="bp">NSNumber</span><span class="o">*</span><span class="n">identifier</span><span class="p">;</span>
</span><span class='line'>  <span class="k">@property</span><span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">strong</span><span class="p">)</span><span class="bp">NSString</span><span class="o">*</span><span class="n">photographerName</span><span class="p">;</span>
</span><span class='line'>  <span class="k">@property</span><span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">strong</span><span class="p">)</span><span class="bp">NSNumber</span><span class="o">*</span><span class="n">rating</span><span class="p">;</span>
</span><span class='line'>  <span class="k">@property</span><span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">strong</span><span class="p">)</span><span class="bp">NSString</span><span class="o">*</span><span class="n">thumbnailURL</span><span class="p">;</span>
</span><span class='line'>  <span class="k">@property</span><span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">strong</span><span class="p">)</span><span class="bp">NSData</span><span class="o">*</span><span class="n">thumbnailData</span><span class="p">;</span>
</span><span class='line'>  <span class="k">@property</span><span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">strong</span><span class="p">)</span><span class="bp">NSString</span><span class="o">*</span><span class="n">fullsizedURL</span><span class="p">;</span>
</span><span class='line'>  <span class="k">@property</span><span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">strong</span><span class="p">)</span><span class="bp">NSData</span><span class="o">*</span><span class="n">fullsizedData</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">@end</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>和传统的用VC直接控制model.我们将抽象的逻辑放在另一个类中<code>FRPPhotoImporter</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="p">@</span><span class="nl">interfaceFRPPhotoImporter</span><span class="p">:</span><span class="bp">NSObject</span>
</span><span class='line'><span class="o">+</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="n">importPhotos</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>图片引入函数<code>importPhotos</code>返回API结果的RAC信号.recommend against using RACSubjects,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="o">+</span><span class="p">(</span><span class="n">RACReplaySubject</span><span class="o">*</span><span class="p">)</span><span class="n">importPhotos</span><span class="p">{</span>
</span><span class='line'>      <span class="n">RACReplaySubject</span> <span class="o">*</span><span class="n">subject</span> <span class="o">=</span> <span class="p">[</span><span class="n">RACReplaySubject</span> <span class="n">subject</span><span class="p">];</span>
</span><span class='line'>      
</span><span class='line'>      <span class="bp">NSURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">popularURLRequest</span><span class="p">];</span>
</span><span class='line'>      <span class="p">[</span><span class="bp">NSURLConnection</span>
</span><span class='line'>        <span class="nl">sendAsynchronousRequest</span><span class="p">:</span><span class="n">request</span>
</span><span class='line'>        <span class="nl">queue</span><span class="p">:[</span><span class="bp">NSOperationQueue</span> <span class="n">mainQueue</span><span class="p">]</span>
</span><span class='line'>        <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span>
</span><span class='line'>            <span class="bp">NSData</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">connectionError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="kt">id</span> <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSJSONSerialization</span>
</span><span class='line'>                  <span class="nl">JSONObjectWithData</span><span class="p">:</span><span class="n">data</span> <span class="nl">options</span><span class="p">:</span><span class="mi">0</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>                  <span class="p">[</span><span class="n">subject</span> <span class="nl">sendNext</span><span class="p">:[[[</span><span class="n">results</span><span class="p">[</span><span class="s">@&quot;photos&quot;</span><span class="p">]</span> <span class="n">rac_sequence</span><span class="p">]</span> <span class="nl">map</span><span class="p">:</span>                  <span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">photoDictionary</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                      <span class="n">FRPPhotoModel</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="p">[</span><span class="n">FRPPhotoModel</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>                      <span class="p">[</span><span class="nb">self</span> <span class="nl">configurePhotoModel</span><span class="p">:</span><span class="n">model</span>
</span><span class='line'>                              <span class="nl">withDictionary</span><span class="p">:</span><span class="n">photoDictionary</span><span class="p">];</span>
</span><span class='line'>                      <span class="p">[</span><span class="nb">self</span> <span class="nl">downloadThumbnailForPhotoModel</span><span class="p">:</span><span class="n">model</span><span class="p">];</span>
</span><span class='line'>                  <span class="k">return</span> <span class="n">model</span><span class="p">;</span> <span class="p">}]</span> <span class="n">array</span><span class="p">]];</span>
</span><span class='line'>                  <span class="p">[</span><span class="n">subject</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                  <span class="p">[</span><span class="n">subject</span> <span class="nl">sendError</span><span class="p">:</span><span class="n">connectionError</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}</span> <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="n">subject</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>首先,创建<code>RACReplaySubject</code>实例.然后,创建异步请求获取照片对象,再立刻返回信号.
当从API获取数据后,回调马上调用,所有订阅者都能收到值</p>

<p><code>RACSubject</code>和子类<code>RACReplaySubject</code>区别在于:
replay保证主要对象只被订阅一次,防止了重复工作(尤其对于网络活动尤为重要).同时,replay对象会存储值并转发到新的订阅者,正如Justin Spahr指出的那样,也能有效防止竞争者状态.</p>

<p>我们是直接发送完成信号而不是发送随着时间变化的流,如果要联合其他操作这就显得有点过度反应.不过,这有助于标志完成一段任务.如果想看更高级的联合,可以看看<a href="https://github.com/octokit/octokit.objc">octokit</a></p>

<p>我们只检测是否有数据返回,虽然这不是最好的方式判断是否有数据,但可以作为教学例子.如果返回数据为nil,发送error信号.否则,解析json.</p>

<p>我们将结果的<em>photo</em>放入序列中,映射,再转回数组.model的数组就是要传递的值,最后发送completed信号.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="o">+</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">configurePhotoModel</span><span class="p">:(</span><span class="n">FRPPhotoModel</span><span class="o">*</span><span class="p">)</span><span class="nl">photoModelwithDictionary</span><span class="p">:(</span><span class="n">NSDictiona</span><span class="err">\</span> <span class="n">ry</span><span class="o">*</span><span class="p">)</span><span class="n">dictionary</span><span class="p">{</span>
</span><span class='line'>  <span class="c1">// Basics details fetched with the first, basic request</span>
</span><span class='line'>    <span class="n">photoModel</span><span class="p">.</span><span class="n">photoName</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="s">@&quot;name&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">photoModel</span><span class="p">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="s">@&quot;id&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">photoModel</span><span class="p">.</span><span class="n">photographerName</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="s">@&quot;user&quot;</span><span class="p">][</span><span class="s">@&quot;username&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">photoModel</span><span class="p">.</span><span class="n">rating</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="s">@&quot;rating&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">photoModel</span><span class="p">.</span><span class="n">thumbnailURL</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">urlForImageSize</span><span class="p">:</span><span class="mi">3</span> <span class="nl">inArray</span><span class="p">:</span><span class="n">dictionary</span><span class="p">[</span><span class="s">@&quot;images&quot;</span><span class="p">]];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// Extended attributes fetched with subsequent request</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="s">@&quot;comments_count&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">photoModel</span><span class="p">.</span><span class="n">fullsizedURL</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">urlForImageSize</span><span class="p">:</span><span class="mi">4</span>                                     <span class="nl">inArray</span><span class="p">:</span><span class="n">dictionary</span><span class="p">[</span><span class="s">@&quot;images&quot;</span><span class="p">]];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="o">+</span><span class="p">(</span><span class="bp">NSString</span><span class="o">*</span><span class="p">)</span><span class="nl">urlForImageSize</span><span class="p">:(</span><span class="bp">NSInteger</span><span class="p">)</span><span class="n">size</span> <span class="nl">inDictionary</span><span class="p">:(</span><span class="bp">NSArray</span><span class="o">*</span><span class="p">)</span><span class="n">array</span><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">[[[[[</span><span class="n">array</span> <span class="n">rac_sequence</span><span class="p">]</span> <span class="nl">filter</span><span class="p">:</span><span class="o">^</span><span class="kt">BOOL</span><span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="s">@&quot;size&quot;</span><span class="p">]</span> <span class="n">integerValue</span><span class="p">]</span> <span class="o">==</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}]</span> <span class="nl">map</span><span class="p">:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="kt">id</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="s">@&quot;url&quot;</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}]</span> <span class="n">array</span><span class="p">]</span> <span class="n">firstObject</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="o">+</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">downloadThumbnailForPhotoModel</span><span class="p">:(</span><span class="n">FRPPhotoModel</span><span class="o">*</span><span class="p">)</span><span class="n">photoModel</span><span class="p">{</span>
</span><span class='line'>      <span class="n">NSAssert</span><span class="p">(</span><span class="n">photoModel</span><span class="p">.</span><span class="n">thumbnailURL</span><span class="p">,</span> <span class="s">@&quot;Thumbnail URL must not be nil&quot;</span><span class="p">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="bp">NSURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURLRequest</span> <span class="nl">requestWithURL</span><span class="p">:[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="n">pho</span>\
</span><span class='line'>      <span class="n">toModel</span><span class="p">.</span><span class="n">thumbnailURL</span><span class="p">]];</span>
</span><span class='line'>      <span class="p">[</span><span class="bp">NSURLConnection</span> <span class="nl">sendAsynchronousRequest</span><span class="p">:</span><span class="n">request</span>
</span><span class='line'>          <span class="nl">queue</span><span class="p">:[</span><span class="bp">NSOperationQueue</span> <span class="n">mainQueue</span><span class="p">]</span>
</span><span class='line'>          <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span>
</span><span class='line'>            <span class="bp">NSData</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">connectionError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">photoModel</span><span class="p">.</span><span class="n">thumbnailData</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="k">@interface</span> <span class="nc">FRPGalleryViewController</span><span class="p">()</span>
</span><span class='line'>  <span class="k">@property</span><span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">strong</span><span class="p">)</span><span class="bp">NSArray</span><span class="o">*</span><span class="n">photosArray</span><span class="p">;</span>
</span><span class='line'>  <span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="k">static</span> <span class="bp">NSString</span><span class="o">*</span><span class="n">CellIdentifier</span><span class="o">=</span><span class="s">@&quot;Cell&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1">// Configure self</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">@&quot;Popular on 500px&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Configure view</span>
</span><span class='line'>      <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">collectionView</span> <span class="nl">registerClass</span><span class="p">:[</span><span class="n">FRPCell</span> <span class="k">class</span><span class="p">]</span>
</span><span class='line'>          <span class="nl">forCellWithReuseIdentifier</span><span class="p">:</span><span class="n">CellIdentifier</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Reactive Stuff</span>
</span><span class='line'>      <span class="p">@</span><span class="n">weakify</span><span class="p">(</span><span class="nb">self</span><span class="p">);</span>
</span><span class='line'>      <span class="p">[</span><span class="n">RACObserve</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">photosArray</span><span class="p">)</span> <span class="nl">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="p">@</span><span class="n">strongify</span><span class="p">(</span><span class="nb">self</span><span class="p">);</span>
</span><span class='line'>          <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">collectionView</span> <span class="n">reloadData</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1">// Load data</span>
</span><span class='line'>      <span class="p">[</span><span class="nb">self</span> <span class="n">loadPopularPhotos</span><span class="p">];</span>
</span><span class='line'>      
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p><code>RACObserver</code>是一个带有两个参数的C宏:对象和对象的KeyPath,当key path的值发生变化他返回信号.释放<em>self</em>的时候返回completed信号.当属性<em>photosArray</em>发生变化collectionView重新加载.</p>

<p>基本上,<code>subscribeNext:</code>会保留self.引起self和block的<strong>retain cycle</strong>.block被<code>subscribeNext:</code>的返回值-<code>RACSubscriber</code>实例保留,接着又被<code>RACObserver</code>保留.一旦释放self,<code>RACObserver</code>会自动释放.没有<strong>weakify/strongify</strong>,self不会被释放掉</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">loadPopularPhotos</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">FRPPhotoImporter</span> <span class="n">importPhotos</span><span class="p">]</span> <span class="nl">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">photosArray</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="nl">error</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Couldn&#39;t fetch photos from 500px: %@&quot;</span><span class="p">,</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[FRP in IOS翻译(3)]]></title>
    <link href="http://passol.tk/blog/2014/10/23/frp-in-iosfan-yi-3/"/>
    <updated>2014-10-23T01:23:00+08:00</updated>
    <id>http://passol.tk/blog/2014/10/23/frp-in-iosfan-yi-3</id>
    <content type="html"><![CDATA[<h1>介绍ReactiveCocoa</h1>

<h2>安装ReactiveCocoa</h2>

<p>ReactiveCocoa并不官方支持Cocoapods,但是开源社区支持.你也可以使用checkout submodule的方式
编写的podFile如下:
<code>
platform :ios "6.0"
target "Playground" do
pod 'ReactiveCocoa', ' 2.1.4'
end
target "PlaygroundTests" do
pod 'ReactiveCocoa', 2.1.4
end
</code></p>

<h2>流和序列</h2>

<ul>
<li>流是一连串值的抽象.你可以把流当成管道,值像流水一样从一端进入,另一端出来.不能取得<strong>过去</strong>的值,即使要得到<strong>现在</strong>的值,也必须是值刚从管道出来的时候.</li>
<li>一连串值有点像list或者数组,可以使用<strong>rac_sequence</strong>方法把NSArray转化成流
<code>
NSArray *array = @[@(1), @(2), @(3)];
RACSequence *stream = [array rac_sequence];
</code>
<em>RACSequence</em>就是<em>RACStream</em>的子类</li>
<li>转化成流后,我们可以使用操作流</li>
<li>map
<code>
[stream map:^id(id value) {
 return @(pow([value integerValue], 2));
}]
</code>
<em>类似于array, 流不能包含nil</em></li>
<li>转换回array
<code>
NSLog(@"%@", [stream array]);
</code></li>
<li>联合1.2结果
<code>
NSLog(@"%@", [[[array rac_sequence] map:^id(id value) {
 return @(pow([value integerValue], 2));
}] array]);
</code>
<strong>sequence</strong>默认是懒惰加载(在用的时候才加载),pull-driven,在被要求的时候才提供值.
<em>filter</em>的例子
<code>
NSLog(@"%@", [[[array rac_sequence] filter:^BOOL(id value) {
 return [value integerValue]%2 == 0;
}]])
</code>
<em>fold</em>的例子:
<code>
NSLog(@"%@", [[[array rac_sequence] map:^id(id value) {
 return [value stringValue];
}] foldLeftWithStart:@"" reduce:^id(id accumulator, id value) {
 return [accumulator stringByAppendingString:value];
}])
</code></li>
<li>在这个例子中.我们组合了两个操作，也是下一节要学的<em>signal</em>.</li>
<li>RAC有left fold和right fold, 分别是从左到右和从右到左</li>
</ul>


<h2>信号</h2>

<ul>
<li>信号是另一种流,它是push-driven,新的值推进管道而不能拉出来.他们抽象出数据以便将来使用.</li>
<li>信号发送三种类型的数据.<em>next</em>送往管道,<em>error</em>代表信号不能顺利完成,<em>completion</em>代表顺利完成.<em>error</em>和<em>completion</em>是互斥的.</li>
<li>信号是RAC核心控件,有很多为UIKit内置的处理函数.<em>UITextField</em>有<em>rac_textSignal</em>方法处理textfield里新的值</li>
</ul>


<h2>订阅</h2>

<ul>
<li>订阅一般针对信号,用作通知新值被传递(next, error或者completion).信号用作以下场景会有副作用(在<em>viewDidLoad</em>中的代码):
<code>
[self.textField.rac_textSignal subscribeNext:^(id x) {
  NSLog(@"New value:%@", x);
} error:^(NSError *error){
  NSLog(@"Error%@", error);
} completed: ^{
  NSLog(@"completed");
}]
</code></li>
<li>Textfield从不传递error值,只在dealloc的时候才传递completion值,所以这两个block几乎不调用.我们可以简化以上结果:
<code>
[self.textField.rac_textSignal subscribeNext:^(id x) {
  NSLog(@"New value %@", x);
}];
</code></li>
<li>当你订阅信号,其实是建立了一个订阅的对象,自动被retain,并且retain信号,你可以手动dispose这个订阅者(不是典型用法).</li>
</ul>


<h2>生成状态</h2>

<ul>
<li>传统的做法是用类的一个属性标记状态变化,但是RAC抽象这个属性到流里,举例:
在textfield中,只要email输入框包含<em>@</em>,只有有效的用户才能促发button enable,或者可以让textField变色提供反馈
<code>
RAC(self.button, enabled) = [self.textField.tac_textSignal map:^id(NSString *value){
  return @([value rangeOfString:@"@"].location != NSNotFound);
}]
</code></li>
<li>RAC宏有两个参数:对象和对象的属性.它提供单向绑定右边的值和对象的属性.值必须是对象.
下面修改textField的颜色:
`
RACSignal <em>validEmailSignal = [self.textField.rac_textSignal map:^id(NSString </em>value) {
  return @([value rangeOfString:@&ldquo;@&rdquo;].location != NSNotFound);
}]</li>
</ul>


<p>RAC(self.button, enabled) = validEmailSignal;
RAC(self.textField, textColor) = [validEmailSignal map:^id(id value) {
    if([value boolVaue]){
        return [UIColor greenColor];
    }else{
        return [UIColor redColor];
    }
}]
`</p>

<h2>命令</h2>

<ul>
<li>上面例子中UIButton可以使用enabled属性是因为RAC的类别扩展了UIButton的属性,可以直接使用button的<em>rac_command</em>直接扩展

<blockquote><p><em>command</em>可以创造和订阅信号的行为,很容易实现单边效果.通常来说,行为是UI触发的.信号也可以disable命令</p></blockquote></li>
<li>命令主要用作响应用户交互时间,在处理命令的时候可以订阅命令的信号(稍后解释)
<code>
self.button.rac_command = [[RACCommand alloc] initWithEnabled:validEmailSingal singalBlock:^RACSignal *(id input){
  NSLog(@"button was pressed");
  return [RACSignal empty];
}]
</code></li>
<li>当按下button的时候signal执行了,<em>rac_command</em>处理绑定信号和enable状态</li>
<li>返回值,我们需要返回一个signal给属于RACCommand的executionSignals管道,直到信号返回完整的值button才会enable.</li>
</ul>


<h2>RACSubject</h2>

<ul>
<li><strong>RACSubject</strong>是代表一种可变的状态,你可以设置新的值.所以总是被用作特殊用途.</li>
</ul>


<h2>冷热信号</h2>

<ul>
<li>信号是lazy的,总是在使用时生成和传递.重复订阅代表重复使用.这种就叫<em>冷信号</em></li>
<li><em>热信号</em>是即时生成和使用,很少用到</li>
</ul>


<h2>多播</h2>

<ul>
<li>多播主要用作多个对象共享订阅一个信号,不太可能重复发送同样的信号,因为可能订阅非常耗资源.例如网络请求</li>
<li><strong>RACMulticastConnection</strong>可以发布RACSignal或者多播,后者可以带上RACSubject参数</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[FRP in IOS翻译(2)]]></title>
    <link href="http://passol.tk/blog/2014/10/23/frp-in-iosfan-yi-2/"/>
    <updated>2014-10-23T01:22:57+08:00</updated>
    <id>http://passol.tk/blog/2014/10/23/frp-in-iosfan-yi-2</id>
    <content type="html"><![CDATA[<h1>使用<em>RXCollections</em>函数式编程</h1>

<h2>高阶函数</h2>

<ul>
<li>使用一个或多个函数当输入</li>
<li>输出一个函数
在OC中使用Block,例如:
遍历函数
<code>
NSArray *array = @[@(1), @(2), @(3)]
</code>
我们可以:
<code>
for (NSNumber *number in array){
  NSLog(@"%@", number);
}
</code>
也可以
<code>
[array enumerateObjectsUsingBlock:^(NSNumber *number, NSUInteger idx, BOOL *stop)]{
  NSLog(@"%@", number);
}
</code>
高阶函数就是函数体,我们可以使用<strong>RXCollections</strong></li>
</ul>


<h2>安装RXCollections</h2>

<p><code>
sudo gem install cocoapods
pod init
</code>
编写podfile:
<code>
platform :ios, "6.0"
target "Playground" do
pod "RXCollections", "1.0"
end
target "PlaygroundTests" do
end
</code>
然后:
<code>
pod install
</code></p>

<p>接着用上面的例子
<code>
NSArray *array = @[@(1), @(2), @(3)]
</code></p>

<h2>Map</h2>

<p><code>
NSArray *mappedArray = [array rx_mapWithBlock:^id(id each) {
    return @(pow([each integerValue], 2));
}]
</code>
结果编程 (1, 4, 9)
特点:
1. 没有修改原值
2. 生成的也是个不可变的数组</p>

<h2>Filter</h2>

<p><code>
NSArray *filteredArray = [array rx_filterWithBlock: ^BOOL(id each){
    return ([each integerValue] % 2 == 0);
}]
</code></p>

<h2>Fold(其实就是求和)</h2>

<p><code>
NSNumber *sum = [array rx_foldWithBlock:^id(id memo, id each){
    return @([memo integerValue] + [each integerValue]);
}]
</code>
数组的每一个成员就是一个sequence, memo就是上一次调用block的返回值(初始为nil)
我们可以这么做:
<code>
[[array rx_mapWithBlock:^id(id each) {
    return [each stringValue];
}] rx_foldInitialValue:@"" block:^id(id memo, id each) {
    return [memo stringByAppendString:each];
}];
</code>
确实更消耗性能不过iphone不怕,硬件不再是短板</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[FRP in IOS翻译(1)]]></title>
    <link href="http://passol.tk/blog/2014/10/23/frp-in-iosfan-yi/"/>
    <updated>2014-10-23T01:21:19+08:00</updated>
    <id>http://passol.tk/blog/2014/10/23/frp-in-iosfan-yi</id>
    <content type="html"><![CDATA[<h1>哲学</h1>

<ul>
<li><strong>函数响应式编程</strong>可以让程序员更lazy,但同时需要花时间来学习.</li>
<li>传统的<strong>交互式编程</strong>依赖于程序员了解整个流程:不停修改程序的状态,而且是特定的顺序才能保证程序的正确性</li>
<li><strong>声明式编程</strong>尽量减少流程控制，而是集中精力在达到的目标上</li>
</ul>


<h2>函数式响应编程</h2>

<ul>
<li><strong>响应式编程</strong>类似于电子表格,如果定义cell A是B和C的和,当B或者C的值发生变化,A总能随着变化</li>
<li><strong>函数式编程</strong>就是函数体(在ios下就是block),没有可变的状态,同样的输入一定有同样的输出.</li>
</ul>


<h2>结论</h2>

<ul>
<li>函数响应式效率更高</li>
<li>声明式编程可以规避必须清楚整个流程</li>
<li>函数响应式式两者的结合</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[简单了解ReactiveCocoa]]></title>
    <link href="http://passol.tk/blog/2014/10/22/jian-dan-liao-jie-reactivecocoa/"/>
    <updated>2014-10-22T23:49:15+08:00</updated>
    <id>http://passol.tk/blog/2014/10/22/jian-dan-liao-jie-reactivecocoa</id>
    <content type="html"><![CDATA[<blockquote><p>想了解RAC莫过于看<a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/README.md">README</a> ,<a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/Documentation/FrameworkOverview.md">Framework Overview</a>和 <a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/Documentation/DesignGuidelines.md">Design Guidelines</a></p></blockquote>

<p>ReactiveCocoa为OC带来了崭新的思路:函数式响应编程范式(FRP)
RAC的作者<a href="https://github.com/joshaber">Josh Abernathy</a> 和 <a href="https://github.com/jspahrsummers">Justin Spahr-Summers</a>是在开发GitHub Mac版本逐渐创建</p>

<p>而什么是FRP呢?它意思是随着时间的变化不能改变输入到输出.<em>Josh Abernathy</em>这么<a href="http://blog.maybeapps.com/post/42894317939/input-and-output">解释</a>的:</p>

<blockquote><p>程序总是通过输入产生输出,输出总是加工输入的结果.输入->转化->输出->完成.</p>

<p>App中,输入就是所有的行为(点击,键盘事件,定时器触发,GPS,或者网络回应等),而App将所有结果组合在一起产生输出.</p>

<p>输出通常是UI变化,也可能是其他变化</p>

<p>与传统范式区别在于,输入和输出可以发生多次,而不仅仅是一次运转过程.App总是能接收输入产生输出.</p></blockquote>

<h2>例子:</h2>

<figure class='code'><figcaption><span>&#8220;传统方式&#8221;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>
</span><span class='line'>    <span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="n">isFormValid</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">usernameField</span><span class="p">.</span><span class="n">text</span> <span class="n">length</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>              <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">emailField</span><span class="p">.</span><span class="n">text</span> <span class="n">length</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>              <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">passwordField</span><span class="p">.</span><span class="n">text</span> <span class="n">length</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>              <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">passwordField</span><span class="p">.</span><span class="n">text</span> <span class="nl">isEqual</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">passwordVerificationField</span><span class="p">.</span><span class="n">text</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#pragma mark - UITextFieldDelegate</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nl">textField</span><span class="p">:(</span><span class="bp">UITextField</span> <span class="o">*</span><span class="p">)</span><span class="n">textField</span> <span class="nl">shouldChangeCharactersInRange</span><span class="p">:</span>   <span class="p">(</span><span class="n">NSRange</span><span class="p">)</span><span class="n">range</span> <span class="nl">replacementString</span><span class="p">:(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">string</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">createButton</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">isFormValid</span><span class="p">];</span>
</span><span class='line'>      <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>传统方式中,逻辑总是分散在VC各个方法中,主要逻辑<code>self.createButton.enabled = [self isFormValid]</code>不得不交织在view声明周期和委托函数中</li>
</ul>


<figure class='code'><figcaption><span>&#8220;RAC&#8221;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>
</span><span class='line'>  <span class="n">RACSignal</span> <span class="o">*</span><span class="n">formValid</span> <span class="o">=</span> <span class="p">[</span><span class="n">RACSignal</span>
</span><span class='line'>      <span class="nl">combineLatest</span><span class="p">:</span><span class="l">@[</span>
</span><span class='line'>                      <span class="nb">self</span><span class="p">.</span><span class="n">username</span><span class="p">.</span><span class="n">rac_textSignal</span><span class="p">,</span>
</span><span class='line'>                      <span class="nb">self</span><span class="p">.</span><span class="n">emailField</span><span class="p">.</span><span class="n">rac_textSignal</span><span class="p">,</span>
</span><span class='line'>                      <span class="nb">self</span><span class="p">.</span><span class="n">passwordField</span><span class="p">.</span><span class="n">rac_textSignal</span><span class="p">,</span>
</span><span class='line'>                      <span class="nb">self</span><span class="p">.</span><span class="n">passwordVerificationField</span><span class="p">.</span><span class="n">rac_textSignal</span><span class="l">]</span>
</span><span class='line'>          <span class="nl">reduce</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="n">username</span><span class="p">,</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">email</span><span class="p">,</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">password</span><span class="p">,</span> <span class="bp">NSString</span>              <span class="o">*</span><span class="n">passwordVerification</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="k">return</span> <span class="l">@(</span>
</span><span class='line'>                      <span class="p">[</span><span class="n">username</span> <span class="n">length</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                      <span class="p">[</span><span class="n">email</span> <span class="n">length</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                      <span class="p">[</span><span class="n">password</span> <span class="n">length</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                      <span class="p">[</span><span class="n">password</span> <span class="nl">isEqual</span><span class="p">:</span><span class="n">passwordVerification</span><span class="p">]</span><span class="l">)</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}];</span>
</span><span class='line'>  <span class="n">RAC</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">createButton</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="o">=</span> <span class="n">formValid</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>所有的验证表单的逻辑可以串在一起,每次textField更新的时候,所有的输入都会产生bool值,自动enable或者disable按钮</li>
</ul>


<h2>大纲</h2>

<ul>
<li>RAC主要有两部分:信号(RACSignal)和序列(RACSequence)</li>
<li>信号和序列继承于流,所以有很多一直的操作.RAC将大部分的方法进行很好的封装和设计:信号属于驱动流,而序列属于被动流</li>
</ul>


<h3>RACSignal</h3>

<ul>
<li>应用于异步操作或者事件驱动数据源(比如用户行为或APP状态变化)</li>
<li>串联独立的行为(上面的例子)</li>
<li>并发执行</li>
</ul>


<p>信号对于订阅者有三种类型的事件:
- <em>next</em>在流操作中得到值,不像Cocoa的集合类,可以包含nil
- <em>error</em>在信号完成前有错误发生,事件总是包含<code>NSError</code>对象,错误需要单独处理
- <em>completed</em>发生在信号顺利完成，也必须要单独处理,因为得不到流的值</p>

<p>信号完整的生命周期总包括多个next事件和一个error或者completed事件(二者不共存)</p>

<h3>RACSequence</h3>

<ul>
<li><p>集合转化,简化操作,主要利用高阶函数(map, filter, fold/reduce)</p></li>
<li><p>序列是一种集合,类似于<code>NSArray</code>.区别在于序列总是[lazy load],在需要的时候才生成值.另外可以包含<code>nil</code></p></li>
<li>序列允许Cocoa集合声明后以统一的形式管理</li>
</ul>


<figure class='code'><figcaption><span>&#8220;RACSequence&#8221;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>
</span><span class='line'>  <span class="n">RACSequence</span> <span class="o">*</span><span class="n">normalizedLongWords</span> <span class="o">=</span> <span class="p">[[</span><span class="n">words</span><span class="p">.</span><span class="n">rac_sequence</span>
</span><span class='line'>      <span class="nl">filter</span><span class="p">:</span><span class="o">^</span> <span class="kt">BOOL</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="n">word</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="k">return</span> <span class="p">[</span><span class="n">word</span> <span class="n">length</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}]</span>
</span><span class='line'>      <span class="nl">map</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="n">word</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="k">return</span> <span class="p">[</span><span class="n">word</span> <span class="n">lowercaseString</span><span class="p">];</span>
</span><span class='line'>              <span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>


<h2>与Cocoa的前世今生</h2>

<p>Cocoa一直都是捕捉和响应变化,RAC只是在概念和功能上扩展.然而,一些基本的东西是一脉相承的:</p>

<h3><strong>RAC</strong> vs <strong>KVO</strong></h3>

<p><a href="http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">Key-Value Observing</a>是Cocoa的核心,RAC也具备响应属性变化.但是KVO不方便使用:太多无用参数和不支持block</p>

<h3><strong>RAC</strong> vs <strong>绑定</strong></h3>

<p>绑定是OSX比较重要的概念,但是在iOS和UIKit缺少支持.虽然绑定浓缩了很多基本代码和操作IB文件,但是共嫩那个有限而且不能debug.RAC提供了类Cocoa的API和能应用大部分场景</p>

<p>在设计中<em>@protocol</em>没有采用C++的多继承,而是抽象的数据范式(类似于Java的接口).OC 2.0引入了<em>@property / @synthesize</em>,简化了setter和getter方法(C#).Block的方式扩展了函数式编程,和GCD完美搭配.子对象和不变对象就来源于Ruby和Javascript</p>

<p>而现在RAC提供了函数式响应编程,也深深受到C#的影响(<a href="">Rx library</a>,<a href="">Clojure</a>, <a href="">Elm</a>)</p>

<h2>扩展阅读</h2>

<ol>
<li><a href="http://nshipster.com/reactivecocoa/">http://nshipster.com/reactivecocoa/</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[markdown语法学习]]></title>
    <link href="http://passol.tk/blog/2014/10/21/markdownyu-fa-xue-xi/"/>
    <updated>2014-10-21T23:36:54+08:00</updated>
    <id>http://passol.tk/blog/2014/10/21/markdownyu-fa-xue-xi</id>
    <content type="html"><![CDATA[<h2>大纲</h2>

<ul>
<li>复习下markdown语法,呵呵</li>
</ul>


<h1>一级标题</h1>

<h2>二级标题</h2>

<h3>三级标题</h3>

<ul>
<li><strong>强调</strong>或者<strong>强调</strong></li>
<li><em>斜体</em>还是<em>斜体</em></li>
</ul>


<blockquote><p>我是引用 &gt;&lt;</p></blockquote>

<ul>
<li>我邮箱 <a href="&#109;&#x61;&#x69;&#108;&#x74;&#111;&#x3a;&#112;&#97;&#115;&#x73;&#x6f;&#108;&#64;&#x31;&#54;&#51;&#x2e;&#99;&#111;&#x6d;">&#112;&#x61;&#115;&#115;&#111;&#x6c;&#64;&#x31;&#x36;&#x33;&#46;&#99;&#111;&#109;</a></li>
<li>链接可以 link <a href="http://passol.herokuapp.com">http://passol.herokuapp.com</a>, 也可以<a href="http://passol.herokuapp.com">链接</a></li>
<li>也可以添加说明 <a href="http://passol.herokuapp.com" title="说明我">链接</a></li>
<li>外部链接 <a href="http://passol.herokuapp.com">外部链接</a></li>
</ul>


<h4>图片</h4>

<p><img src="http://smallerapp.com/favicon.ico" title="Title here" alt="Smaller icon" /> title是可选的</p>

<p>A <img src="http://resizesafari.com/favicon.ico" title="Title" alt="Resize icon" /> reference style image.</p>

<h4>内部代码块</h4>

<p><code>关键字</code></p>

<pre><code>关键代码
</code></pre>

<h4>有序列表</h4>

<ol>
<li>一</li>
<li>二</li>
<li>三</li>
</ol>


<h4>无序列表</h4>

<ul>
<li>呵呵</li>
<li>呵呵</li>
<li>呵呵呵</li>
</ul>


<h4>水平分割线</h4>

<hr />

<hr />

<hr />

<h4>脚注</h4>

<p>这是一个脚注.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<h4>删除线</h4>

<p><del>被删除</del></p>

<h4>表格</h4>

<p>A simple table looks like this:</p>

<table>
<thead>
<tr>
<th>First Header </th>
<th> Second Header </th>
<th> Third Header</th>
</tr>
</thead>
<tbody>
<tr>
<td>Content Cell </td>
<td> Content Cell  </td>
<td> Content Cell</td>
</tr>
<tr>
<td>Content Cell </td>
<td> Content Cell  </td>
<td> Content Cell</td>
</tr>
</tbody>
</table>


<p>If you wish, you can add a leading and tailing pipe to each line of the table:</p>

<table>
<thead>
<tr>
<th> First Header </th>
<th> Second Header </th>
<th> Third Header </th>
</tr>
</thead>
<tbody>
<tr>
<td> Content Cell </td>
<td> Content Cell  </td>
<td> Content Cell </td>
</tr>
<tr>
<td> Content Cell </td>
<td> Content Cell  </td>
<td> Content Cell </td>
</tr>
</tbody>
</table>


<p>Specify alignement for each column by adding colons to separator lines:</p>

<table>
<thead>
<tr>
<th style="text-align:left;">First Header </th>
<th style="text-align:center;"> Second Header </th>
<th style="text-align:right;"> Third Header</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">Left         </td>
<td style="text-align:center;"> Center        </td>
<td style="text-align:right;"> Right</td>
</tr>
<tr>
<td style="text-align:left;">Left         </td>
<td style="text-align:center;"> Center        </td>
<td style="text-align:right;"> Right</td>
</tr>
</tbody>
</table>


<h4>代码分享</h4>

<blockquote><pre><code class="[language] [title] [url] [link text]">code snippet
</code></pre></blockquote>

<ul>
<li>简略设置</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone git@github.com:imathis/octopress.git # fork octopress</span></code></pre></td></tr></table></div></figure>


<ul>
<li>附加信息</li>
</ul>


<figure class='code'><figcaption><span>HelloWorld</span><a href='http://passol.tk'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Hello world!&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>嵌入gist</li>
</ul>


<div><script src='https://gist.github.com/4321346.js'></script>
<noscript><pre><code>@@ -590,7 +590,7 @@ class SpritesTest &lt; Test::Unit::TestCase
  it &quot;should generate a sprite from nested folders&quot; do
    css = render &lt;&lt;-SCSS
-     @import &quot;nested/*.png&quot;;
+     @import &quot;nested/**/*.png&quot;;
      @include all-nested-sprites;
    SCSS
    assert_correct css, &lt;&lt;-CSS</code></pre></noscript></div>




<div><script src='https://gist.github.com/4321346.js?file=gistfile1.diff'></script>
<noscript><pre><code>@@ -590,7 +590,7 @@ class SpritesTest &lt; Test::Unit::TestCase
  it &quot;should generate a sprite from nested folders&quot; do
    css = render &lt;&lt;-SCSS
-     @import &quot;nested/*.png&quot;;
+     @import &quot;nested/**/*.png&quot;;
      @include all-nested-sprites;
    SCSS
    assert_correct css, &lt;&lt;-CSS</code></pre></noscript></div>


<ul>
<li>Example</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Awesome code snippet</span></code></pre></td></tr></table></div></figure>


<ul>
<li>objc</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="n">rectangle</span> <span class="nl">setX</span><span class="p">:</span> <span class="mi">10</span> <span class="nl">y</span><span class="p">:</span> <span class="mi">10</span> <span class="nl">width</span><span class="p">:</span> <span class="mi">20</span> <span class="nl">height</span><span class="p">:</span> <span class="mi">20</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>更多参考资料</p>

<ol>
<li><a href="http://octopress.org/docs/blogging/code/">http://octopress.org/docs/blogging/code/</a></li>
<li><a href="https://stackedit.io/editor">https://stackedit.io/editor</a></li>
<li><a href="https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet#html">https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet#html</a></li>
<li><a href="http://ishowshao.com/blog/2013/10/15/octopress-with-qiniu/">http://ishowshao.com/blog/2013/10/15/octopress-with-qiniu/</a></li>
<li><a href="http://blog.raphaelzhang.com/2012/03/lightweight-markup-markdown/">http://blog.raphaelzhang.com/2012/03/lightweight-markup-markdown/</a></li>
<li><a href="http://octopress.org/docs/">http://octopress.org/docs/</a></li>
<li><a href="http://www.jianshu.com/p/1e402922ee32">http://www.jianshu.com/p/1e402922ee32</a></li>
<li><a href="http://www.jianshu.com/p/q81RER">http://www.jianshu.com/p/q81RER</a></li>
</ol>

<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>脚注内容<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[部署octopress到heroku]]></title>
    <link href="http://passol.tk/blog/2014/10/21/bu-shu-octopressdao-heroku/"/>
    <updated>2014-10-21T23:15:19+08:00</updated>
    <id>http://passol.tk/blog/2014/10/21/bu-shu-octopressdao-heroku</id>
    <content type="html"><![CDATA[<h2>下载octopress</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone git@github.com:imathis/octopress.git # fork octopress
</span><span class='line'>$ cd octopress</span></code></pre></td></tr></table></div></figure>


<h2>ruby准备工作</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gem install bundler
</span><span class='line'>$ bundle install
</span><span class='line'>$ rake install</span></code></pre></td></tr></table></div></figure>


<h2>发布</h2>

<ul>
<li>打开.gitignore文件,去掉<em>public</em>和<em>Gemfile.lock</em>,否则不能发布到heroku上面</li>
</ul>


<h2>可以指定域名</h2>

<ul>
<li>免费可以搜索下tk域名</li>
</ul>


<h2>定制配置(<em>_config.yml</em>)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>url: http://xblog.herokuapp.com
</span><span class='line'>title: First
</span><span class='line'>subtitle: heheh
</span><span class='line'>author: xblog</span></code></pre></td></tr></table></div></figure>


<h2>添加博客</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rake new_post["title"]</span></code></pre></td></tr></table></div></figure>


<h2>本地发布</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rake generate
</span><span class='line'>$ rake preview</span></code></pre></td></tr></table></div></figure>


<p>直接浏览<a href="http://localhost:4000">http://localhost:4000</a>便可以看到</p>

<h2>创建heroku app</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gem install heroku
</span><span class='line'>$ heroku create passol
</span><span class='line'>$ git add .
</span><span class='line'>$ git commit -m "first post"
</span><span class='line'>$ git push heroku master</span></code></pre></td></tr></table></div></figure>


<h2>打开App</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku open</span></code></pre></td></tr></table></div></figure>


<p>或者直接打开<a href="http://passol.herokuapp.com">http://passol.herokuapp.com</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第一篇]]></title>
    <link href="http://passol.tk/blog/2014/10/21/first/"/>
    <updated>2014-10-21T00:33:47+08:00</updated>
    <id>http://passol.tk/blog/2014/10/21/first</id>
    <content type="html"><![CDATA[<figure class='code'><figcaption><span>HelloWorld</span><a href='http://passol.tk'>Source Article</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Hello world!&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
